# eblog

​	eblog 是一个根据B站UP主[MarkerHub](https://space.bilibili.com/13491144)、基于 Springboot 开发的博客学习项目，视频链接https://www.bilibili.com/video/BV1ri4y1x71A。主要功能有：自定义 Freemarker 标签，使用 shiro+redis 完成会话共享，redis 的 zset 结构完成本周热议排行榜，t-io+websocket 完成即时消息通知和群聊，rabbitmq+elasticsearch 完成博客内容搜索引擎等。虽然内容很多，但是我还是把重点放在了后端实现的逻辑上，并未过多关注前端的实现。

## 1.项目搭建



![image-20220207195608931](https://gitee.com/yun-xiaojie/blog-image/raw/master/img/image-20220207195608931.png)

pom.xml 的依赖包如下：

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.6.3</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.lyj</groupId>
    <artifactId>eblog</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>eblog</name>
    <description>eblog</description>
    <properties>
        <java.version>11</java.version>
    </properties>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-freemarker</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!--mybatisPlus-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.1</version>
        </dependency>
        <!-- sql分析器 -->
        <dependency>
            <groupId>p6spy</groupId>
            <artifactId>p6spy</artifactId>
            <version>3.8.6</version>
        </dependency>

        <!-- commons-lang3 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
            <version>3.9</version>
        </dependency>

    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

在application.yml 中编写配置文件：

```yaml
# DataSource Config
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
#    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
#    url: jdbc:p6spy:mysql://localhost:3306/eblog?useSSL=true&useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
    url: jdbc:mysql://localhost:3306/eblog?useSSL=true&useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
    username: root
    password: 7012+2
    hikari:
      # 连接池名
      pool-name: DateHikariCP
      # 最小空闲连接池
      minimum-idle: 5
      # 最大连接数 默认10
      maximum-pool-size: 10
      # 连接池返回的连接自动提交
      auto-commit: true
      # 连接最大存活时间 0表示永久存活 默认1800000 （30分钟）
      max-lifetime: 1800000
      # 连接超时时间 默认30000（30秒）
      connection-timeout: 30000
      # 测试连接是否可用的查询语句
      connection-test-query: select 1
```

新建数据库，并使用MybatisPlus代码生成器自动生成对应的类。

## 2.页面

![Snipaste_2022-02-11_09-45-46](https://gitee.com/yun-xiaojie/blog-image/raw/master/img/Snipaste_2022-02-11_09-45-46.png)

根据上图将首页划分为几个区域，前端页面的实现忽略，只关注后端代码。

- 有些数据是项目启动的时候就需要的

  - ```java
    /**
     * 实现功能：
     * 项目启动的时候便运行以下代码: header-panel中的类别
     *
     */
    @Component
    public class ContextStartUp implements ApplicationRunner, ServletContextAware {
    
        @Autowired
        ICategoryService categoryService;
    
        ServletContext servletContext;
    
        @Autowired
        IPostService postService;
    
        @Override
        public void run(ApplicationArguments args) throws Exception {
    
            List<Category> categories = categoryService.list(new QueryWrapper<Category>()
                    .eq("status", 0)
            );
            servletContext.setAttribute("categories", categories);
    
            /*本周热议
            *
            * 项目启功的时候便初始化
            * */
            postService.initWeekRank();
        }
    
        @Override
        public void setServletContext(ServletContext servletContext) {
            this.servletContext = servletContext;
        }
    }
    
    ```

- **首页**

  - ```java
    @Controller
    public class IndexController extends BaseController {
    
        @RequestMapping({"", "/", "/index"})
        public String index() {
    
            /*参数：1分页信息 2分类 3用户 4置顶 5精选 6排序*/
            IPage results = postService.paging(getPage(), null, null, null, null, "created");
            /*分页的数据*/
            request.setAttribute("pageData", results);
    
            /*默认首页的id是0*/
            request.setAttribute("currentCategoryId", 0);
            return "index";
        }
    }
    ```

  - ```java
    /**
     *  服务类
     *
     * @author LiuYunJie
     * @since 2022-02-08
     */
    public interface IPostService extends IService<Post> {
        /**
         * 自实现的分页功能
         * @param page          分页信息
         * @param categoryId    分类信息
         * @param userId        用户信息
         * @param level         置顶等级
         * @param recommend     是否推荐
         * @param order         排序方式
         * @return
         */
        IPage paging(Page page, Long categoryId, Long userId, Integer level,
                     Boolean recommend, String order);
    }
    
    ```

  - ```java
    /**
     *  服务实现类
     *
     * @author LiuYunJie
     * @since 2022-02-08
     */
    @Service
    public class PostServiceImpl extends ServiceImpl<PostMapper, Post> implements IPostService {
    
        @Autowired
        PostMapper postMapper;
    
        @Autowired
        RedisUtil redisUtil;
    
        @Override
        public IPage paging(Page page, Long categoryId, Long userId,
                            Integer level, Boolean recommend, String order) {
            if (level == null) {
                level = -1;
            }
            QueryWrapper<Post> wrapper = new QueryWrapper<Post>()
    
                    .eq(categoryId != null, "category_id", categoryId)
                    .eq(userId != null, "user_id", userId)
                    .eq(level == 0, "level", 0)
                    .gt(level > 0, "level", 0)
                    .orderByDesc(order != null, order);
            return postMapper.selectPosts(page, wrapper);
        }
    
        /**
         * 本周热议
         */
        @Override
        public void initWeekRank() {
    
            /*获取7天内发表的文章*/
            List<Post> posts = this.list(new QueryWrapper<Post>()
                    .ge("created", DateUtil.lastWeek())
                    .select("id, title, user_id, comment_count, view_count, created"));
    
            /*初始化文章的总评论量*/
            for (Post post: posts) {
                String key = "day:rank:" + DateUtil.format(post.getCreated(),
                        DatePattern.PURE_DATE_FORMAT);
                redisUtil.zSet(key, post.getId(), post.getCommentCount());
    
                /*7天后自动过期*/
                long between = DateUtil.between(new Date(), post.getCreated(), DateUnit.DAY); // 天
                long expireTime = (7 - between) * 24 * 3600; // 剩余过期时间 秒
    
                redisUtil.expire(key, expireTime); /*设置key的存活时间*/
    
                /*缓存文章的一些基本信息(id、标题、评论数量、作者)*/
                this.hashCachePostInformation(post, expireTime);
    
            }
    
            /*并集*/
            this.zunionAndStoredLast7DayForWeekRank();
    
        }
    
        /**
         * 评论数增加以后自动更新本周热议功能
         * @param postId
         * @param isIncr
         */
        @Override
        public void incrCommentCountAndUnionForWeekRank(long postId, boolean isIncr) {
            String  currentKey = "day:rank:" + DateUtil.format(new Date(), DatePattern.PURE_DATE_FORMAT);
            redisUtil.zIncrementScore(currentKey, postId, isIncr? 1: -1);
    
            Post post = this.getById(postId);
    
            // 7天后自动过期(15号发表，7-（18-15）=4)
            long between = DateUtil.between(new Date(), post.getCreated(), DateUnit.DAY);
            long expireTime = (7 - between) * 24 * 60 * 60; // 有效时间
    
            // 缓存这篇文章的基本信息
            this.hashCachePostInformation(post, expireTime);
    
            // 重新做并集
            this.zunionAndStoredLast7DayForWeekRank();
        }
    
        /**
         * 阅读量加1
         * @param postVo
         */
        @Override
        public void putViewCount(PostVo postVo) {
            String key = "rank:post:" + postVo.getId();
    
            /*1 从缓存中获取viewCount(阅读量)*/
            Integer viewCount = (Integer) redisUtil.hget(key, "post:viewCount");
    
            /*2 如果没有 就从数据库中获取 再加1*/
            if (viewCount !=null) {
                postVo.setViewCount(viewCount + 1);
            } else {
                postVo.setViewCount(postVo.getViewCount() + 1);
            }
    
            /*3 同步到缓存中*/
            redisUtil.hset(key, "post:viewCount", postVo.getViewCount());
        }
    
        /**
         * 本周合并每日评论数量操作
         */
        private void zunionAndStoredLast7DayForWeekRank() {
            String  currentKey = "day:rank:" + DateUtil.format(new Date(), DatePattern.PURE_DATE_FORMAT);
    
            String destKey = "week:rank";
            List<String> otherKeys = new ArrayList<>();
            for(int i=-6; i < 0; i++) {
                String temp = "day:rank:" +
                        DateUtil.format(DateUtil.offsetDay(new Date(), i), DatePattern.PURE_DATE_FORMAT);
    
                otherKeys.add(temp);
            }
    
            redisUtil.zUnionAndStore(currentKey, otherKeys, destKey);
        }
    
        /**
         * 缓存文章的基本信息
         * @param post
         * @param expireTime
         */
        private void hashCachePostInformation(Post post, long expireTime) {
            String key = "rank:post:" + post.getId();
            boolean hasKey = redisUtil.hasKey(key);
            if (!hasKey) {
                redisUtil.hset(key, "post:id", post.getId(), expireTime);
                redisUtil.hset(key, "post:title", post.getTitle(), expireTime);
                redisUtil.hset(key, "post:commentCount", post.getCommentCount(), expireTime);
                redisUtil.hset(key, "post:viewCount", post.getViewCount(), expireTime);
            }
        }
    }
    ```

  - ```java
    @Component
    public interface PostMapper extends BaseMapper<Post> {
    
        IPage<PostVo> selectPosts(Page page,
                                  @Param(Constants.WRAPPER) QueryWrapper<Post> wrapper);
    
        PostVo selectOnePost(@Param(Constants.WRAPPER)QueryWrapper<Post> wrapper);
    }
    ```

  - ```java
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.lyj.eblog.mapper.PostMapper">
    
        <!-- 通用查询映射结果 -->
        <resultMap id="BaseResultMap" type="com.lyj.eblog.pojo.Post">
            <id column="id" property="id" />
            <result column="title" property="title" />
            <result column="content" property="content" />
            <result column="edit_mode" property="editMode" />
            <result column="category_id" property="categoryId" />
            <result column="user_id" property="userId" />
            <result column="vote_up" property="voteUp" />
            <result column="vote_down" property="voteDown" />
            <result column="view_count" property="viewCount" />
            <result column="comment_count" property="commentCount" />
            <result column="recommend" property="recommend" />
            <result column="level" property="level" />
            <result column="status" property="status" />
            <result column="created" property="created" />
            <result column="modified" property="modified" />
        </resultMap>
    
        <!-- 通用查询结果列 -->
        <sql id="Base_Column_List">
            id, title, content, edit_mode, category_id, user_id, vote_up, vote_down, view_count, comment_count, recommend, level, status, created, modified
        </sql>
    
        <select id="selectPosts" resultType="com.lyj.eblog.Vo.PostVo">
            SELECT
                p.*,
                u.id AS authorId,
                u.username AS authorName,
                u.avatar AS authorAvatar,
    
                c.id AS categoryId,
                c.name AS categoryName
            FROM
                m_post p
                    LEFT JOIN m_user u ON p.user_id = u.id
                    LEFT JOIN m_category c ON p.category_id = c.id
            ${ew.customSqlSegment}
        </select>
    
        <select id="selectOnePost" resultType="com.lyj.eblog.Vo.PostVo">
            SELECT
                p.*,
                u.id AS authorId,
                u.username AS authorName,
                u.avatar AS authorAvatar,
    
                c.id AS categoryId,
                c.name AS categoryName
            FROM
                m_post p
                    LEFT JOIN m_user u ON p.user_id = u.id
                    LEFT JOIN m_category c ON p.category_id = c.id
                ${ew.customSqlSegment}
        </select>
    </mapper>
    
    ```

> BaseController 的作用是减少重复的代码，将一些相似的代码放到一起。

```java
@Controller
public class BaseController {

    @Autowired
    HttpServletRequest request;

    @Autowired
    IPostService postService;

    @Autowired
    ICommentService commentService;

    @Autowired
    IUserService userService;

    @Autowired
    IUserMessageService userMessageService;

    @Autowired
    IUserCollectionService userCollectionService;

    @Autowired
    ICategoryService categoryService;

    @Autowired
    WsService wsService;

    @Autowired
    SearchService searchService;

    @Autowired
    AmqpTemplate amqpTemplate;

    public Page getPage() {
        int pn = ServletRequestUtils.getIntParameter(request, "pn", 1);
        int size = ServletRequestUtils.getIntParameter(request, "size", 2);
        return new Page(pn, size);
    }

    protected AccountProfile getProfile() {
        return (AccountProfile)SecurityUtils.getSubject().getPrincipal();
    }

    protected Long getProfileId() {
        return getProfile().getId();
    }
}
```







### 2.1导航栏

```java
/**
 * 实现功能：
 * 项目启动的时候便运行以下代码: header-panel中的类别
 *
 */
@Component
public class ContextStartUp implements ApplicationRunner, ServletContextAware {

    @Autowired
    ICategoryService categoryService;

    ServletContext servletContext;

    @Override
    public void run(ApplicationArguments args) throws Exception {

        List<Category> categories = categoryService.list(new QueryWrapper<Category>()
                .eq("status", 0)
        );
        servletContext.setAttribute("categories", categories);
    }

    @Override
    public void setServletContext(ServletContext servletContext) {
        this.servletContext = servletContext;
    }
}
```







![image-20220210105417833](https://gitee.com/yun-xiaojie/blog-image/raw/master/img/image-20220210105417833.png)



## 分页





## 本周热议、文章阅读量

### 本周热议

> 本周：7天内
>
> 热议：评论最多
>
> 思路：单独记录每天的评论量。
>
> 方法：使用 Redis 的 Zset，存储日期以及文章id。

- 因为本周热议是项目启动就存在，所以在 ContextStartUp.java 中编写该功能。

  - ```java
            /*本周热议
            *
            * 项目启功的时候便初始化
            * */
            postService.initWeekRank();
    ```

- 实现该方法

  - ```java
    /**
     *  服务实现类
     *
     * @author LiuYunJie
     * @since 2022-02-08
     */
    @Service
    public class PostServiceImpl extends ServiceImpl<PostMapper, Post> implements IPostService {
    
        @Autowired
        PostMapper postMapper;
    
        @Autowired
        RedisUtil redisUtil;
    
        @Override
        public IPage paging(Page page, Long categoryId, Long userId,
                            Integer level, Boolean recommend, String order) {
            if (level == null) {
                level = -1;
            }
            QueryWrapper<Post> wrapper = new QueryWrapper<Post>()
    
                    .eq(categoryId != null, "category_id", categoryId)
                    .eq(userId != null, "user_id", userId)
                    .eq(level == 0, "level", 0)
                    .gt(level > 0, "level", 0)
                    .orderByDesc(order != null, order);
            return postMapper.selectPosts(page, wrapper);
        }
    
        @Override
        public PostVo selectOnePost(QueryWrapper<Post> wrapper) {
            return postMapper.selectOnePost(wrapper);
        }
    
        /**
         * 本周热议
         */
        @Override
        public void initWeekRank() {
    
            /*获取7天内发表的文章*/
            List<Post> posts = this.list(new QueryWrapper<Post>()
                    .ge("created", DateUtil.lastWeek())
                    .select("id, title, user_id, comment_count, view_count, created"));
    
            /*初始化文章的总评论量*/
            for (Post post: posts) {
                String key = "day:rank:" + DateUtil.format(post.getCreated(),
                        DatePattern.PURE_DATE_FORMAT);
                redisUtil.zSet(key, post.getId(), post.getCommentCount());
    
                /*7天后自动过期*/
                long between = DateUtil.between(new Date(), post.getCreated(), DateUnit.DAY); // 天
                long expireTime = (7 - between) * 24 * 3600; // 剩余过期时间 秒
    
                redisUtil.expire(key, expireTime); /*设置key的存活时间*/
    
                /*缓存文章的一些基本信息(id、标题、评论数量、作者)*/
                this.hashCachePostInformation(post, expireTime);
    
            }
    
            /*并集*/
            this.zunionAndStoredLast7DayForWeekRank();
    
        }
        /**
         * 本周合并每日评论数量操作
         */
        private void zunionAndStoredLast7DayForWeekRank() {
            String  currentKey = "day:rank:" + DateUtil.format(new Date(), DatePattern.PURE_DATE_FORMAT);
    
            String destKey = "week:rank";
            List<String> otherKeys = new ArrayList<>();
            for(int i=-6; i < 0; i++) {
                String temp = "day:rank:" +
                        DateUtil.format(DateUtil.offsetDay(new Date(), i), DatePattern.PURE_DATE_FORMAT);
    
                otherKeys.add(temp);
            }
    
            redisUtil.zUnionAndStore(currentKey, otherKeys, destKey);
        }
    
        /**
         * 缓存文章的基本信息
         * @param post
         * @param expireTime
         */
        private void hashCachePostInformation(Post post, long expireTime) {
            String key = "rank:post:" + post.getId();
            boolean hasKey = redisUtil.hasKey(key);
            if (!hasKey) {
                redisUtil.hset(key, "post:id", post.getId(), expireTime);
                redisUtil.hset(key, "post:title", post.getTitle(), expireTime);
                redisUtil.hset(key, "post:commentCount", post.getCommentCount(), expireTime);
                redisUtil.hset(key, "post:viewCount", post.getViewCount(), expireTime);
            }
        }
            /**
         * 评论数增加以后自动更新本周热议功能
         * @param postId
         * @param isIncr
         */
        @Override
        public void incrCommentCountAndUnionForWeekRank(long postId, boolean isIncr) {
            String  currentKey = "day:rank:" + DateUtil.format(new Date(), DatePattern.PURE_DATE_FORMAT);
            redisUtil.zIncrementScore(currentKey, postId, isIncr? 1: -1);
    
            Post post = this.getById(postId);
    
            // 7天后自动过期(15号发表，7-（18-15）=4)
            long between = DateUtil.between(new Date(), post.getCreated(), DateUnit.DAY);
            long expireTime = (7 - between) * 24 * 60 * 60; // 有效时间
    
            // 缓存这篇文章的基本信息
            this.hashCachePostInformation(post, expireTime);
    
            // 重新做并集
            this.zunionAndStoredLast7DayForWeekRank();
        }
    }
    ```
  
- 定义模板，**没看懂**

  - ```java
    /**
     * 本周热议
     */
    @Component
    public class HotsTemplate extends TemplateDirective {
    
        @Autowired
        RedisUtil redisUtil;
    
        @Override
        public String getName() {
            return "hots";
        }
    
        @Override
        public void execute(DirectiveHandler handler) throws Exception {
            String weekRankKey = "week:rank";
    
            Set<ZSetOperations.TypedTuple> typedTuples = redisUtil.getZSetRank(weekRankKey, 0, 6);
    
            List<Map> hotPosts = new ArrayList<>();
    
            for (ZSetOperations.TypedTuple typedTuple : typedTuples) {
                Map<String, Object> map = new HashMap<>();
    
                Object value = typedTuple.getValue(); // post的id
                String postKey = "rank:post:" + value;
    
                map.put("id", value);
                map.put("title", redisUtil.hget(postKey, "post:title"));
                map.put("commentCount", typedTuple.getScore());
    
                hotPosts.add(map);
            }
    
            handler.put(RESULTS, hotPosts).render();
        }
    }
    
    ```
  
- 修改前端页面

### 文章阅读量

- 阅读量+1功能：

  - PostController.java

  - ```java
            /**
             * 阅读量加1
             * */
            postService.putViewCount(postVo);
    ```

  - PostServerImpl.java

  - ```java
        @Override
        public void putViewCount(PostVo vo) {
            String key = "rank:post:" + vo.getId();
    
            // 1、从缓存中获取viewcount
            Integer viewCount = (Integer) redisUtil.hget(key, "post:viewCount");
    
            // 2、如果没有，就先从实体里面获取，再加一
            if(viewCount != null) {
                vo.setViewCount(viewCount + 1);
            } else {
                vo.setViewCount(vo.getViewCount() + 1);
            }
    
            // 3、同步到缓存里面
            redisUtil.hset(key, "post:viewCount", vo.getViewCount());
        }
    ```

- **定时器**：缓存与数据库同步

  - ```java
    @EnableScheduling
    @SpringBootApplication
    @MapperScan("com.lyj.eblog.mapper")
    public class EblogApplication {
    
        public static void main(String[] args) {
            SpringApplication.run(EblogApplication.class, args);
            System.out.println("Test");
        }
    }
    
    ```

  - ViewCountSync.java

  - ```java
    package com.lyj.eblog.schedules;
    
    import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
    import com.lyj.eblog.pojo.Post;
    import com.lyj.eblog.service.IPostService;
    import com.lyj.eblog.util.RedisUtil;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.data.redis.core.RedisTemplate;
    import org.springframework.scheduling.annotation.Scheduled;
    import org.springframework.stereotype.Component;
    
    import java.util.ArrayList;
    import java.util.List;
    import java.util.Set;
    
    
    /**
     * 定时器功能：将缓存中的文章阅读量同步到数据库
     */
    @Component
    public class ViewCountSync {
    
        @Autowired
        RedisUtil redisUtil;
    
        @Autowired
        RedisTemplate redisTemplate;
    
        @Autowired
        IPostService postService;
    
    
        @Scheduled(cron = "0/5 * * * * *") //每分钟同步
        public void task() {
    
            Set<String> keys = redisTemplate.keys("rank:post:*");
    
            List<String> ids = new ArrayList<>();
            for (String key : keys) {
                if(redisUtil.hHasKey(key, "post:viewCount")){
                    ids.add(key.substring("rank:post:".length()));
                }
            }
    
            if(ids.isEmpty()) return;
    
            // 需要更新阅读量
            List<Post> posts = postService.list(new QueryWrapper<Post>().in("id", ids));
    
            posts.stream().forEach((post) ->{
                Integer viewCount = (Integer) redisUtil.hget("rank:post:" + post.getId(), "post:viewCount");
                post.setViewCount(viewCount);
            });
    
            if(posts.isEmpty()) return;
    
            boolean isSuccess = postService.updateBatchById(posts);
    
            if(isSuccess) {
                ids.stream().forEach((id) -> {
                    redisUtil.hdel("rank:post:" + id, "post:viewCount");
                    System.out.println(id + "---------------------->同步成功");
                });
            }
        }
    }
    
    ```

![image-20220211174317013](https://gitee.com/yun-xiaojie/blog-image/raw/master/img/image-20220211174317013.png)

![image-20220211174357769](https://gitee.com/yun-xiaojie/blog-image/raw/master/img/image-20220211174357769.png)



## 登录与注册



![image-20220213224039587](https://gitee.com/yun-xiaojie/blog-image/raw/master/img/image-20220213224039587.png)